<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
</head>
<body ng-app="fired-up" ng-controller="LoginController">

<form>
    <input type="email"     ng-model="login.form.email">
    <input type="password"  ng-model="login.form.password">
    <button ng-click="user.signIn(login.form.email, login.form.password)">Sign In</button>
    <button ng-click="user.signOut()">Sign Out</button>
</form>

<form ng-show="user.id">
    <input type="text" ng-model="form.name">
    <input type="text" ng-model="form.picture">
    <button ng-click="user.updateProfile(form.name, form.picture)">Save</button>
</form>
<!--<script src="https://www.gstatic.com/firebasejs/3.5.3/firebase.js"></script>-->
<script src="firebase.js"></script>
<script src="../../lib/angular-1.4.3.js"></script>
<script>

    var  app = angular.module("fired-up", []);

    app.value("credentials", {
        apiKey: "AIzaSyAt3rD67xE5KvwyAk645-tRrKDAG3KH_jY",
        authDomain: "programmers-4d280.firebaseapp.com",
        databaseURL: "https://programmers-4d280.firebaseio.com",
        storageBucket: "programmers-4d280.appspot.com",
        messagingSenderId: "188124641306"
    })

    app.service("RemoteService", function (credentials) {
        var app = firebase.initializeApp(credentials);
        app.auth().onAuthStateChanged(function (user) {
            if (user) {
                // User is signed in.
                console.log("Signed In : " + JSON.stringify(user))
            } else {
                console.log("Not logged in")
            }
        });

        var
                signIn = function (userEmail, userPassword) {
                    return app.auth().signInWithEmailAndPassword(userEmail, userPassword)
                            .catch(function (error) {
                                console.error(error.message);
                            });
                },
                signOut = function (userEmail, userPassword) {
                    return app.auth().signOut()
                            .catch(function (error) {
                                console.error(error.message);
                            });
                },
                createAccount = function (userEmail, userPassword) {
                    app.auth().createUserWithEmailAndPassword(userEmail, userPassword)
                            .then(function (user) {
                                console.log("user created successfully.")
                            })
                            .catch(function (error) {
                                var errorCode = error.code;
                                var errorMessage = error.message;
                                if (errorCode == 'auth/weak-password') {
                                    console.error('The password is too weak.');
                                }
                                console.error(errorMessage);
                            });
                },
                writeUserData = function (userId, name, picture) {
                    return app.database().ref('users/' + userId+"/profile").set({
                        name: name,
                        picture: picture
                    });
                };

        var service = {
            signOut: signOut,
            writeUserData: writeUserData,
            signIn: function(userEmail, userPassword){
                return signIn(userEmail, userPassword).then(function(user){
                    service.session.user.id = user.uid;
                    service.session.user.name = user.displayName;
                    return user;
                });
            },
            createAccount: createAccount,
            setUserDetails: writeUserData,
            session: {
                user: {
                    id: null,
                    name: null,
                    email: null,
                    picture: null,
                    signOut: function () {
                        return signOut();
                    },
                    signIn: signIn,
                    updateProfile: function(name, picture){
                        return writeUserData(session.user.id, name, picture)
                                .then(function () {
                                    session.user.name = name;
                                    session.user.picture = picture;
                                });
                    }
                },
                active: function(){
                    return !!service.session.user.id;
                }

            }
        };
        return service
    });

    app.service("UserService", ["RemoteService", function (remoteService) {
       return {
           user: {
               id: null,
               name: null,
               email: null,
               picture: null,
               signIn: function(userEmail, userPassword){
                   return remoteService.signIn(userEmail, userPassword).then(function(user){
                       user.id    = user.uid;
                       user.name  = user.displayName;
                       user.email = userEmail;
                       return user;
                   });
               },
               signOut: function () {
                   return remoteService.signOut();
               },
               updateProfile: function(name, picture){
                   return remoteService.writeUserData(user.id, name, picture)
                           .then(function () {
                               user.name = name;
                               user.picture = picture;
                           });
               }
           }
       };
    }]);

    app.controller("LoginController", ["$scope", "RemoteService", "UserService", function ($scope, remoteService, userService) {

        var login = {
            form: {
                email:     "nishants.singh87@gmaisl.com",
                password: "123456",
                submit: function(){
                    remoteService.signIn(login.form.email, login.form.password).then(function (user) {
                        console.log("user logged in \n" + JSON.stringify(user));
                    });
                }
            }
        };

        $scope.login = login;
        $scope.user = userService.user;
    }]);

</script>
</body>
</html>