<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="../favicon.gif" type="image/gif" sizes="16x16">

    <link href="style/index.css" rel="stylesheet" >
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="../../lib/ace/ace.js"></script>
    <script src="../../lib/ace/theme-monokai.js"></script>
    <script src="../../lib/ace/mode-ruby.js"></script>
    <script src="../../lib/ace/ext-beautify.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular.min.js"></script>

    <meta charset="UTF-8">
    <title>amoeba social labs</title>
</head>
<style>

</style>
<body ng-app="ruby-for-qa" ng-controller="editorController">

<div id="top-bar">
    <div id="section-name">ruby for qa &gt; exercise-one</div>
    <div id="run-button"><a class="btn btn-default" ng-click="editor.run()">run</a></div>
</div>
<div class="main-container">
    <div class="editor-view">
        <div id="editor"></div>
    </div>
</div>

<div class="console"
     ng-class="{'show' : editor.console.show}">
    <div class="title">Result</div>
    <textarea class="output"
         ng-bind="editor.console.output">

    </textarea>
</div>

<script>

    var app = angular.module("ruby-for-qa", []);
    app.value("compileServers",[{
        name: "default",
        url: "http://amoeba-social-rubylab.herokuapp.com"
    }]);
    app.config(function($httpProvider) {
        //Enable cross domain calls
        $httpProvider.defaults.useXDomain = true;

        //Remove the header containing XMLHttpRequest used to identify ajax call
        //that would prevent CORS from working
        $httpProvider.defaults.headers.common = {};
        $httpProvider.defaults.headers.post = {};
        $httpProvider.defaults.headers.put = {};
        $httpProvider.defaults.headers.patch = {};
        $httpProvider.defaults.headers.options = {};
    });

    app.service("taskService", ["$http", "compileServers", function($http, compileServers){
        var remote = compileServers[0];

        return {
            getAssignment : function(id){
                return $http.get(remote.url+"/tasks/:id/worksheet".replace(":id", id)).then(function(response){
                    return response.data;
                })
            },
            evaluateAssignment : function(taskId, solutionText){
                return $http.put(remote.url+"/tasks/:id/evaluate".replace(":id", taskId), solutionText).then(function(response){
                    return response.data;
                })
            }
        }
    }]);
    app.controller("editorController", ["$scope", "taskService", function($scope, taskService){
        var editor = {
                content: null,
                console  : {
                    show: false,
                },
                ace: ace.edit("editor"),
                run: function(){
                    taskService.evaluateAssignment("exercise-one", editor.ace.getValue()).then(function(result){
                        editor.console.output = result;
                        editor.console.show = true;
                    });
                }
            };

        taskService.getAssignment("exercise-one").then(function(worksheet){
            editor.ace.setValue(worksheet);
        });

        editor.ace.setTheme("ace/theme/monokai");
        editor.ace.getSession().setMode("ace/mode/ruby");
        editor.ace.getSession().setMode("ace/mode/ruby");
        $scope.editor = editor;
    }]);
</script>
</body>
</html>